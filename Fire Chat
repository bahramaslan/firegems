package com.example.onefilechat

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.compose.foundation.background
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.items
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.text.style.TextAlign
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import java.text.SimpleDateFormat
import java.util.*

/* ---------- مدل‌ها ---------- */

data class User(
    val id: String,
    val name: String
)

data class Chat(
    val id: String,
    val title: String,
    val lastMessage: String,
    val lastTime: String
)

data class Message(
    val id: String = UUID.randomUUID().toString(),
    val chatId: String,
    val senderId: String,
    val senderName: String,
    val text: String,
    val time: String,
    val isMine: Boolean
)

/* ---------- حالت صفحه‌ها ---------- */

sealed class Screen {
    object Login : Screen()
    object ChatList : Screen()
    data class ChatDetail(val chatId: String) : Screen()
}

/* ---------- اکتیویتی اصلی (همه‌چیز اینجاست) ---------- */

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent {
            OneFileChatApp()
        }
    }
}

/* ---------- اپ اصلی ---------- */

@Composable
fun OneFileChatApp() {
    var currentScreen by remember { mutableStateOf<Screen>(Screen.Login) }

    // کاربر فعلی
    var currentUser by remember {
        mutableStateOf<User?>(null)
    }

    // چت‌ها
    val chats = remember {
        mutableStateListOf(
            Chat(
                id = "1",
                title = "چت عمومی",
                lastMessage = "به چت عمومی خوش آمدید",
                lastTime = "10:05"
            ),
            Chat(
                id = "2",
                title = "گروه جم‌ هایی آتشین",
                lastMessage = "خوش آمدی بهرام!",
                lastTime = "09:40"
            )
        )
    }

    // پیام‌ها
    val messages = remember {
        mutableStateListOf<Message>(
            Message(
                chatId = "1",
                senderId = "system",
                senderName = "سیستم",
                text = "سلام! این یک چت آزمایشی است.",
                time = "10:05",
                isMine = false
            ),
            Message(
                chatId = "2",
                senderId = "admin",
                senderName = "ادمین",
                text = "به گروه جم‌هایی آتشین خوش آمدید.",
                time = "09:40",
                isMine = false
            )
        )
    }

    Surface(
        modifier = Modifier.fillMaxSize(),
        color = Color(0xFFECE5DD)
    ) {
        when (val screen = currentScreen) {
            is Screen.Login -> LoginScreen(
                onLogin = { name ->
                    val user = User(id = UUID.randomUUID().toString(), name = name)
                    currentUser = user
                    currentScreen = Screen.ChatList
                }
            )

            is Screen.ChatList -> ChatListScreen(
                currentUser = currentUser,
                chats = chats,
                messages = messages,
                onChatClick = { chatId ->
                    currentScreen = Screen.ChatDetail(chatId)
                }
            )

            is Screen.ChatDetail -> ChatDetailScreen(
                currentUser = currentUser,
                chatId = screen.chatId,
                chats = chats,
                messages = messages,
                onBack = { currentScreen = Screen.ChatList }
            )
        }
    }
}

/* ---------- صفحه ورود (نام کاربر) ---------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun LoginScreen(onLogin: (String) -> Unit) {
    var nameText by remember { mutableStateOf(TextFieldValue("")) }

    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(24.dp),
        horizontalAlignment = Alignment.CenterHorizontally,
        verticalArrangement = Arrangement.Center
    ) {

        Text(
            text = "ورود به چت‌اپ",
            fontSize = 24.sp,
            fontWeight = FontWeight.Bold,
            modifier = Modifier.padding(bottom = 24.dp)
        )

        OutlinedTextField(
            value = nameText,
            onValueChange = { nameText = it },
            label = { Text("نام شما") },
            placeholder = { Text("مثلاً: بهرام") },
            modifier = Modifier.fillMaxWidth()
        )

        Spacer(modifier = Modifier.height(16.dp))

        Button(
            onClick = {
                val name = nameText.text.trim()
                if (name.isNotEmpty()) {
                    onLogin(name)
                }
            },
            modifier = Modifier.fillMaxWidth()
        ) {
            Text("ورود به چت‌ها")
        }
    }
}

/* ---------- صفحه لیست چت‌ها ---------- */

@Composable
fun ChatListScreen(
    currentUser: User?,
    chats: List<Chat>,
    messages: List<Message>,
    onChatClick: (String) -> Unit
) {
    Column(
        modifier = Modifier.fillMaxSize()
    ) {
        TopAppBar(
            title = {
                Text(
                    text = "چت‌های شما" + if (currentUser != null) " (${currentUser.name})" else "",
                )
            }
        )

        LazyColumn(
            modifier = Modifier
                .fillMaxSize()
                .padding(8.dp),
            verticalArrangement = Arrangement.spacedBy(6.dp)
        ) {
            items(chats) { chat ->
                ChatListItem(
                    chat = chat,
                    onClick = { onChatClick(chat.id) }
                )
            }
        }
    }
}

@Composable
fun ChatListItem(chat: Chat, onClick: () -> Unit) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { onClick() },
        colors = CardDefaults.cardColors(
            containerColor = Color.White
        )
    ) {
        Column(
            modifier = Modifier.padding(12.dp)
        ) {
            Text(
                text = chat.title,
                fontSize = 18.sp,
                fontWeight = FontWeight.Bold
            )
            Spacer(modifier = Modifier.height(4.dp))
            Text(
                text = chat.lastMessage,
                fontSize = 14.sp,
                color = Color.DarkGray,
                maxLines = 1
            )
            Spacer(modifier = Modifier.height(2.dp))
            Text(
                text = "آخرین پیام: ${chat.lastTime}",
                fontSize = 12.sp,
                color = Color.Gray
            )
        }
    }
}

/* ---------- صفحه چت ---------- */

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun ChatDetailScreen(
    currentUser: User?,
    chatId: String,
    chats: MutableList<Chat>,
    messages: MutableList<Message>,
    onBack: () -> Unit
) {
    val chat = chats.find { it.id == chatId }
    var messageText by remember { mutableStateOf(TextFieldValue("")) }

    Scaffold(
        topBar = {
            TopAppBar(
                title = {
                    Text(text = chat?.title ?: "چت")
                },
                navigationIcon = {
                    Text(
                        text = "برگشت",
                        modifier = Modifier
                            .padding(start = 12.dp)
                            .clickable { onBack() },
                        color = Color.Blue
                    )
                }
            )
        },
        bottomBar = {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .padding(8.dp),
                verticalAlignment = Alignment.CenterVertically
            ) {
                OutlinedTextField(
                    value = messageText,
                    onValueChange = { messageText = it },
                    modifier = Modifier
                        .weight(1f)
                        .padding(end = 8.dp),
                    placeholder = { Text("پیام خود را بنویسید...") }
                )
                Button(
                    onClick = {
                        val txt = messageText.text.trim()
                        if (txt.isNotEmpty() && currentUser != null && chat != null) {

                            val time = SimpleDateFormat("HH:mm", Locale.getDefault())
                                .format(Date())

                            val msg = Message(
                                chatId = chat.id,
                                senderId = currentUser.id,
                                senderName = currentUser.name,
                                text = txt,
                                time = time,
                                isMine = true
                            )
                            messages.add(msg)

                            val index = chats.indexOfFirst { it.id == chat.id }
                            if (index != -1) {
                                chats[index] = chats[index].copy(
                                    lastMessage = txt,
                                    lastTime = time
                                )
                            }

                            messageText = TextFieldValue("")
                        }
                    }
                ) {
                    Text("ارسال")
                }
            }
        }
    ) { innerPadding ->

        val chatMessages = messages.filter { it.chatId == chatId }

        Box(
            modifier = Modifier
                .fillMaxSize()
                .padding(innerPadding)
                .background(Color(0xFFECE5DD))
        ) {
            LazyColumn(
                modifier = Modifier
                    .fillMaxSize()
                    .padding(8.dp),
                verticalArrangement = Arrangement.spacedBy(6.dp),
                reverseLayout = false
            ) {
                items(chatMessages) { msg ->
                    MessageBubble(msg)
                }
            }
        }
    }
}

/* ---------- حباب پیام ---------- */

@Composable
fun MessageBubble(message: Message) {
    val bubbleColor = if (message.isMine) Color(0xFFDCF8C6) else Color.White
    val alignment =
        if (message.isMine) Arrangement.End else Arrangement.Start
    val textAlign =
        if (message.isMine) TextAlign.End else TextAlign.Start

    Row(
        modifier = Modifier.fillMaxWidth(),
        horizontalArrangement = alignment
    ) {
        Column(
            modifier = Modifier
                .widthIn(max = 260.dp)
                .background(bubbleColor, shape = MaterialTheme.shapes.medium)
                .padding(8.dp)
        ) {
            if (!message.isMine) {
                Text(
                    text = message.senderName,
                    fontSize = 12.sp,
                    fontWeight = FontWeight.Bold,
                    color = Color(0xFF075E54),
                    textAlign = textAlign,
                    modifier = Modifier.fillMaxWidth()
                )
                Spacer(modifier = Modifier.height(2.dp))
            }
            Text(
                text = message.text,
                color = Color.Black,
                textAlign = textAlign,
                modifier = Modifier.fillMaxWidth()
            )
            Spacer(modifier = Modifier.height(2.dp))
            Text(
                text = message.time,
                fontSize = 10.sp,
                color = Color.DarkGray,
                textAlign = TextAlign.End,
                modifier = Modifier.fillMaxWidth()
            )
        }
    }
}
